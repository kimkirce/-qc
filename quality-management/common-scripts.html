<script>
    // í˜ì´ì§€ ì „í™˜
    function showPage(pageId) {
      document.querySelectorAll('.page-content').forEach(page => {
        page.classList.remove('active');
      });

      const target = document.getElementById(pageId);
      if (target) {
        target.classList.add('active');
      }

      document.querySelectorAll('.nav-item, .nav-subitem').forEach(item => {
        item.classList.remove('active');
      });

      if (event && event.target) {
        event.target.closest('.nav-item, .nav-subitem')?.classList.add('active');
      }

      if (window.innerWidth <= 1024) {
        document.getElementById('sidebar').classList.remove('active');
      }

      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      // TP-101-02 í˜ì´ì§€ ì—´ë¦´ ë•Œ ë°ì´í„° ë¡œë“œ
      if (pageId === 'tp101-02') {
        setTimeout(function() {
          loadEvaluations();
        }, 300);
      }
      
      // ì—…ì²´ë“±ë¡ í˜ì´ì§€ ì—´ë¦´ ë•Œ ë°ì´í„° ë¡œë“œ
      if (pageId === 'company-register') {
        setTimeout(function() {
          console.log('ì—…ì²´ë“±ë¡ í˜ì´ì§€ ì—´ë¦¼ - ëª©ë¡ ë¡œë“œ ì‹œì‘');
          loadCompanyList();
        }, 300);
      }
      
      // ë©”ë‰´ê´€ë¦¬ í˜ì´ì§€ ì—´ë¦´ ë•Œ ë°ì´í„° ë¡œë“œ
      if (pageId === 'menu-manage') {
        setTimeout(function() {
          loadMenuList();
        }, 300);
      }
    }

    // ì„œë¸Œë©”ë‰´ í† ê¸€
    function toggleSubmenu(submenuId) {
      const submenu = document.getElementById(submenuId);
      const parentItem = event.target.closest('.nav-item');
      
      submenu.classList.toggle('show');
      parentItem.classList.toggle('expanded');
      
      document.querySelectorAll('.nav-submenu').forEach(menu => {
        if (menu.id !== submenuId) {
          menu.classList.remove('show');
        }
      });
      
      document.querySelectorAll('.nav-item').forEach(item => {
        if (item !== parentItem && !item.classList.contains('nav-subitem')) {
          item.classList.remove('expanded');
        }
      });
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }

    // TP-101 í‰ê°€ ê´€ë ¨ í•¨ìˆ˜ë“¤
    function calculateTotal() {
      const career = parseInt(document.querySelector('input[name="career"]:checked')?.value || 0);
      const manpower = parseInt(document.querySelector('input[name="manpower"]:checked')?.value || 0);
      const finance = parseInt(document.querySelector('input[name="finance"]:checked')?.value || 0);
      const price = parseInt(document.querySelector('input[name="price"]:checked')?.value || 0);
      const quality = parseInt(document.querySelector('input[name="quality"]:checked')?.value || 0);
      const evaluator = parseInt(document.querySelector('input[name="evaluator"]:checked')?.value || 0);
      const iso = document.getElementById('isoBonus')?.checked ? 10 : 0;

      document.getElementById('careerScore').textContent = career;
      document.getElementById('manpowerScore').textContent = manpower;
      document.getElementById('financeScore').textContent = finance;
      document.getElementById('priceScore').textContent = price;
      document.getElementById('qualityScore').textContent = quality;
      document.getElementById('evaluatorScore').textContent = evaluator;
      document.getElementById('isoScore').textContent = iso;

      const total = career + manpower + finance + price + quality + evaluator + iso;
      document.getElementById('totalScore').textContent = total;

      return total;
    }

    function newEvaluation() {
      document.getElementById('companyName').value = '';
      document.getElementById('businessNo').value = '';
      document.getElementById('ceo').value = '';
      document.getElementById('establishDate').value = '';
      document.getElementById('address').value = '';
      document.getElementById('evalMethodEtc').value = '';
      document.getElementById('evaluatorOpinion').value = '';
      document.getElementById('evalDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('evaluatorName').value = '';

      document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
      document.getElementById('isoBonus').checked = false;

      calculateTotal();
      document.getElementById('evaluationForm').scrollIntoView({ behavior: 'smooth' });
    }

    function saveEvaluation() {
      const companyName = document.getElementById('companyName').value;
      const evalDate = document.getElementById('evalDate').value;
      const evaluatorName = document.getElementById('evaluatorName').value;
      const totalScore = calculateTotal();

      if (!companyName) {
        alert('âŒ ì—…ì²´ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!evalDate) {
        alert('âŒ í‰ê°€ì¼ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!evaluatorName) {
        alert('âŒ í‰ê°€ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (totalScore === 0) {
        alert('âŒ í‰ê°€ í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const data = {
        companyName: companyName,
        businessNo: document.getElementById('businessNo').value,
        ceo: document.getElementById('ceo').value,
        establishDate: document.getElementById('establishDate').value,
        address: document.getElementById('address').value,
        evalMethod: document.querySelector('input[name="evalMethod"]:checked')?.value,
        evalMethodEtc: document.getElementById('evalMethodEtc').value,
        career: parseInt(document.querySelector('input[name="career"]:checked')?.value || 0),
        manpower: parseInt(document.querySelector('input[name="manpower"]:checked')?.value || 0),
        finance: parseInt(document.querySelector('input[name="finance"]:checked')?.value || 0),
        price: parseInt(document.querySelector('input[name="price"]:checked')?.value || 0),
        quality: parseInt(document.querySelector('input[name="quality"]:checked')?.value || 0),
        evaluator: parseInt(document.querySelector('input[name="evaluator"]:checked')?.value || 0),
        iso: document.getElementById('isoBonus').checked,
        totalScore: totalScore,
        opinion: document.getElementById('evaluatorOpinion').value,
        evalDate: evalDate,
        evaluatorName: evaluatorName
      };

      const saveBtn = event.target;
      saveBtn.disabled = true;
      saveBtn.textContent = 'ğŸ’¾ ì €ì¥ ì¤‘...';

      google.script.run
        .withSuccessHandler(function(result) {
          alert('âœ… ' + result.message);
          newEvaluation();
          loadEvaluations();
          saveBtn.disabled = false;
          saveBtn.innerHTML = 'ğŸ’¾ ì €ì¥';
        })
        .withFailureHandler(function(error) {
          alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
          saveBtn.disabled = false;
          saveBtn.innerHTML = 'ğŸ’¾ ì €ì¥';
        })
        .saveTP101Evaluation(data);
    }

    function loadEvaluations() {
      console.log('========================================');
      console.log('í‰ê°€ ëª©ë¡ ë¡œë“œ ì‹œì‘');
      console.log('ì‹œê°„:', new Date().toISOString());
      console.log('========================================');
      
      const tbody = document.getElementById('evaluationList');
      
      if (!tbody) {
        console.error('evaluationList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--text-tertiary);"><div class="loading"></div><div style="margin-top: 12px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></td></tr>';

      google.script.run
        .withSuccessHandler(function(result) {
          console.log('========================================');
          console.log('ì„œë²„ ì‘ë‹µ ìˆ˜ì‹ ');
          console.log('ì‘ë‹µ íƒ€ì…:', typeof result);
          console.log('ì‘ë‹µ ë‚´ìš©:', result);
          console.log('========================================');
          
          // null ì²´í¬
          if (result === null || result === undefined) {
            console.error('âŒ null ë˜ëŠ” undefined ë°˜í™˜!');
            tbody.innerHTML = `
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px;">
                  <div style="font-size: 64px; margin-bottom: 20px;">âš ï¸</div>
                  <div style="font-size: 20px; font-weight: 700; margin-bottom: 16px; color: var(--warning);">null ë°˜í™˜ë¨!</div>
                  <div style="color: var(--text-tertiary); font-size: 14px; margin-bottom: 24px;">
                    í•¨ìˆ˜ê°€ nullì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤. ì¬ë°°í¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.
                  </div>
                </td>
              </tr>
            `;
            return;
          }
          
          // success ì†ì„± ì²´í¬
          if (result.success === false) {
            console.error('âŒ í•¨ìˆ˜ ì‹¤í–‰ ì‹¤íŒ¨:', result.message);
            tbody.innerHTML = `
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px;">
                  <div style="font-size: 64px; margin-bottom: 20px;">âŒ</div>
                  <div style="font-size: 20px; font-weight: 700; margin-bottom: 16px; color: var(--danger);">${result.message || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨'}</div>
                  <div style="color: var(--text-tertiary); font-size: 14px; margin-bottom: 24px;">
                    ë‹¨ê³„: ${result.step || 'ì•Œ ìˆ˜ ì—†ìŒ'}
                  </div>
                </td>
              </tr>
            `;
            return;
          }
          
          // data ì†ì„± ì²´í¬
          if (!result.data) {
            console.error('âŒ result.dataê°€ ì—†ìŠµë‹ˆë‹¤!');
            tbody.innerHTML = `
              <tr>
                <td colspan="7" style="text-align: center; padding: 30px;">
                  <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
                  <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px; color: var(--warning);">ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜</div>
                </td>
              </tr>
            `;
            return;
          }
          
          // ë°ì´í„°ê°€ ë¹„ì–´ìˆëŠ” ê²½ìš°
          if (result.data.length === 0) {
            console.log('â„¹ï¸ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤');
            tbody.innerHTML = `
              <tr>
                <td colspan="7" class="empty-state">
                  <div class="icon">ğŸ“Š</div>
                  <h3>í‰ê°€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                  <p>ìœ„ ì–‘ì‹ì„ ì‘ì„±í•˜ê³  ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
                </td>
              </tr>
            `;
            return;
          }

          // ì •ìƒ ì²˜ë¦¬ - ì˜¬ë°”ë¥¸ í•„ë“œëª… ì‚¬ìš©
          console.log('âœ… ë°ì´í„° í‘œì‹œ ì‹œì‘:', result.data.length + 'ê±´');
          tbody.innerHTML = '';
          result.data.forEach(function(eval, index) {
            const selected = eval.selectionStatus === 'ì„ ì •';
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td style="text-align: center;">${eval.no || index + 1}</td>
              <td>${eval.companyName || '-'}</td>
              <td style="text-align: center;">${eval.evaluationDate || '-'}</td>
              <td style="text-align: center; font-weight: 700; color: ${selected ? 'var(--success)' : 'var(--danger)'};">${eval.totalScore || 0}ì </td>
              <td style="text-align: center;"><span class="status-badge ${selected ? 'success' : 'danger'}">${eval.selectionStatus || 'ë¯¸ì„ ì •'}</span></td>
              <td style="text-align: center;">${eval.evaluatorName || '-'}</td>
              <td style="text-align: center;">
                <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px; margin-right: 4px;" onclick="viewEvaluationFromSheet(${eval.rowNum})">ğŸ‘ï¸ ë³´ê¸°</button>
                <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteEvaluationFromSheet(${eval.rowNum})">ğŸ—‘ï¸ ì‚­ì œ</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
          
          console.log('========================================');
          console.log('âœ… í‰ê°€ ëª©ë¡ í‘œì‹œ ì™„ë£Œ:', result.data.length + 'ê±´');
          console.log('ë²„ì „:', result.version);
          console.log('========================================');
        })
        .withFailureHandler(function(error) {
          console.error('========================================');
          console.error('âŒ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ');
          console.error('ì˜¤ë¥˜ ë‚´ìš©:', error);
          console.error('========================================');
          
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 30px;">
                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ’¥</div>
                <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px; color: var(--danger);">ì„œë²„ ì˜¤ë¥˜ ë°œìƒ</div>
                <div style="color: var(--text-tertiary); font-size: 14px; margin-bottom: 20px;">
                  ${error.message || error}
                </div>
              </td>
            </tr>
          `;
        })
        .getTP101Evaluations();
    }

    function viewEvaluationFromSheet(rowNum) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result || !result.success || !result.data) {
            alert('âŒ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }

          // rowNumìœ¼ë¡œ ë°ì´í„° ì°¾ê¸°
          const eval = result.data.find(e => e.rowNum === rowNum);
          if (!eval) {
            alert('âŒ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }

          // ì˜¬ë°”ë¥¸ í•„ë“œëª…ìœ¼ë¡œ í¼ ì±„ìš°ê¸°
          document.getElementById('companyName').value = eval.companyName || '';
          document.getElementById('businessNo').value = eval.businessNumber || '';
          document.getElementById('ceo').value = eval.representative || '';
          document.getElementById('establishDate').value = eval.establishmentDate || '';
          document.getElementById('address').value = eval.address || '';
          document.getElementById('evalMethodEtc').value = eval.evalMethodEtc || '';
          document.getElementById('evaluatorOpinion').value = eval.evaluatorOpinion || '';
          document.getElementById('evalDate').value = eval.evaluationDate || '';
          document.getElementById('evaluatorName').value = eval.evaluatorName || '';

          // í‰ê°€ë°©ë²• ë¼ë””ì˜¤ ë²„íŠ¼
          if (eval.evaluationMethod) {
            document.querySelectorAll('input[name="evalMethod"]').forEach(radio => {
              if (radio.value === eval.evaluationMethod) radio.checked = true;
            });
          }

          // ì ìˆ˜ ë¼ë””ì˜¤ ë²„íŠ¼ë“¤
          if (eval.experienceScore) {
            const careerRadio = document.querySelector(`input[name="career"][value="${eval.experienceScore}"]`);
            if (careerRadio) careerRadio.checked = true;
          }
          if (eval.personnelScore) {
            const manpowerRadio = document.querySelector(`input[name="manpower"][value="${eval.personnelScore}"]`);
            if (manpowerRadio) manpowerRadio.checked = true;
          }
          if (eval.financialScore) {
            const financeRadio = document.querySelector(`input[name="finance"][value="${eval.financialScore}"]`);
            if (financeRadio) financeRadio.checked = true;
          }
          if (eval.priceScore) {
            const priceRadio = document.querySelector(`input[name="price"][value="${eval.priceScore}"]`);
            if (priceRadio) priceRadio.checked = true;
          }
          if (eval.qualityScore) {
            const qualityRadio = document.querySelector(`input[name="quality"][value="${eval.qualityScore}"]`);
            if (qualityRadio) qualityRadio.checked = true;
          }
          if (eval.evaluatorScore) {
            const evaluatorRadio = document.querySelector(`input[name="evaluator"][value="${eval.evaluatorScore}"]`);
            if (evaluatorRadio) evaluatorRadio.checked = true;
          }
          
          // ISO ì¸ì¦
          document.getElementById('isoBonus').checked = (eval.isoCertification === 'Y');

          calculateTotal();
          document.getElementById('evaluationForm').scrollIntoView({ behavior: 'smooth' });
        })
        .withFailureHandler(function(error) {
          alert('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
        })
        .getTP101Evaluations();
    }

    function deleteEvaluationFromSheet(rowNum) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      google.script.run
        .withSuccessHandler(function(result) {
          alert('âœ… ' + result.message);
          loadEvaluations();
        })
        .withFailureHandler(function(error) {
          alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
        })
        .deleteTP101Evaluation(rowNum);
    }

    function printEvaluation() {
      const companyName = document.getElementById('companyName').value;
      
      if (!companyName) {
        alert('âŒ ì¶œë ¥í•  í‰ê°€ ë°ì´í„°ë¥¼ ë¨¼ì € ì…ë ¥í•˜ê±°ë‚˜ ëª©ë¡ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      alert('ğŸ“„ PDF ì¶œë ¥ ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.\n\ní˜„ì¬ëŠ” ë¸Œë¼ìš°ì €ì˜ ì¸ì‡„ ê¸°ëŠ¥(Ctrl+P)ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
    }

    // ========================================
    // ì—…ì²´ ê´€ë¦¬ í•¨ìˆ˜ë“¤
    // ========================================
    
    // ì—…ì²´ ëª©ë¡ ë¡œë“œ
    function loadCompanyList() {
      console.log('ì—…ì²´ ëª©ë¡ ë¡œë“œ ì‹œì‘');
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('ì—…ì²´ ëª©ë¡ ë¡œë“œ ê²°ê³¼:', result);
          
          if (result.success && result.data) {
            updateCompanyDropdown(result.data);
            updateCompanyTable(result.data);
          } else {
            console.error('ì—…ì²´ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', result.message);
            // ë¹ˆ ëª©ë¡ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            updateCompanyDropdown([]);
            updateCompanyTable([]);
          }
        })
        .withFailureHandler(function(error) {
          console.error('ì—…ì²´ ëª©ë¡ ë¡œë“œ ì—ëŸ¬:', error);
          alert('âŒ ì—…ì²´ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
        })
        .getCompanyList();
    }
    
    // ì—…ì²´ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ í•„ë“œëª…ì— ë§ì¶¤)
    let companyDataCache = [];  // ì—…ì²´ ë°ì´í„° ìºì‹œ
    
    function updateCompanyDropdown(companies) {
      const select = document.getElementById('companyName');
      if (!select) return;
      
      // ìºì‹œì— ì €ì¥
      companyDataCache = companies;
      
      const currentValue = select.value;
      select.innerHTML = '<option value="">ì—…ì²´ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
      
      companies.forEach(company => {
        const option = document.createElement('option');
        option.value = company.companyName;  // ê¸°ì¡´ í•„ë“œëª…
        option.textContent = company.companyName;
        if (company.companyName === currentValue) {
          option.selected = true;
        }
        select.appendChild(option);
      });
      
      console.log(`ì—…ì²´ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${companies.length}ê°œ`);
    }
    
    // ì—…ì²´ ì„ íƒ ì‹œ ì •ë³´ ìë™ ì…ë ¥
    function loadCompanyInfo() {
      const selectedName = document.getElementById('companyName').value;
      
      if (!selectedName) {
        // ì„ íƒ í•´ì œ ì‹œ ì´ˆê¸°í™”
        document.getElementById('businessNo').value = '';
        document.getElementById('ceo').value = '';
        document.getElementById('address').value = '';
        return;
      }
      
      // ìºì‹œì—ì„œ ì—…ì²´ ì •ë³´ ì°¾ê¸°
      const company = companyDataCache.find(c => c.companyName === selectedName);
      
      if (company) {
        document.getElementById('businessNo').value = company.businessNumber || '';
        document.getElementById('ceo').value = company.representative || '';
        document.getElementById('address').value = company.address || '';
        
        console.log('ì—…ì²´ ì •ë³´ ìë™ ì…ë ¥ ì™„ë£Œ:', selectedName);
      }
    }
    
    // ì—…ì²´ í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ê¸°ì¡´ í•„ë“œëª…ì— ë§ì¶¤)
    function updateCompanyTable(companies) {
      const tbody = document.getElementById('companyListTable');
      if (!tbody) return;
      
      if (companies.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="padding: 40px; text-align: center; color: var(--text-tertiary);">
              <div style="font-size: 48px; margin-bottom: 16px;">ğŸ¢</div>
              <div>ë“±ë¡ëœ ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤</div>
              <div style="font-size: 13px; margin-top: 8px;">ìœ„ì˜ í¼ì—ì„œ ìƒˆ ì—…ì²´ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = companies.map((company, index) => `
        <tr style="border-bottom: 1px solid var(--border);">
          <td style="padding: 12px; font-weight: 500;">${company.companyName || '-'}</td>
          <td style="padding: 12px; color: var(--text-secondary);">${company.businessNumber || '-'}</td>
          <td style="padding: 12px; color: var(--text-secondary);">${company.representative || '-'}</td>
          <td style="padding: 12px; color: var(--text-secondary);">${company.manager || '-'}</td>
          <td style="padding: 12px; color: var(--text-secondary);">${company.phone || '-'}</td>
          <td style="padding: 12px; color: var(--text-secondary);">${company.email || '-'}</td>
          <td style="padding: 12px; text-align: center;">
            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteCompany(${company.no})">
              ğŸ—‘ï¸ ì‚­ì œ
            </button>
          </td>
        </tr>
      `).join('');
      
      console.log(`ì—…ì²´ í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${companies.length}ê°œ`);
    }
    
    // ìƒˆ ì—…ì²´ ì¶”ê°€ (ê¸°ì¡´ í•„ë“œëª…ì— ë§ì¶¤)
    function addNewCompany() {
      const name = document.getElementById('newCompanyName').value.trim();
      
      if (!name) {
        alert('âŒ ì—…ì²´ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const data = {
        companyName: name,
        businessNumber: document.getElementById('newCompanyBusinessNo').value.trim(),
        representative: document.getElementById('newCompanyCeo').value.trim(),
        manager: document.getElementById('newCompanyManager').value.trim(),
        phone: document.getElementById('newCompanyPhone').value.trim(),
        email: document.getElementById('newCompanyEmail').value.trim(),
        address: document.getElementById('newCompanyAddress').value.trim()
      };
      
      google.script.run
        .withSuccessHandler(function(result) {
          alert('âœ… ' + result.message);
          
          // ì…ë ¥ í¼ ì´ˆê¸°í™”
          document.getElementById('newCompanyName').value = '';
          document.getElementById('newCompanyBusinessNo').value = '';
          document.getElementById('newCompanyCeo').value = '';
          document.getElementById('newCompanyManager').value = '';
          document.getElementById('newCompanyPhone').value = '';
          document.getElementById('newCompanyEmail').value = '';
          document.getElementById('newCompanyAddress').value = '';
          
          // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          loadCompanyList();
        })
        .withFailureHandler(function(error) {
          alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
        })
        .saveCompany(data);
    }
    
    // ì—…ì²´ ì‚­ì œ
    function deleteCompany(no) {
      if (!confirm('ì •ë§ ì´ ì—…ì²´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      google.script.run
        .withSuccessHandler(function(result) {
          alert('âœ… ' + result.message);
          loadCompanyList();
        })
        .withFailureHandler(function(error) {
          alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
        })
        .deleteCompany(no);
    }
    
    // ì—…ì²´ ëª©ë¡ ì €ì¥ (ì¬ì •ë ¬ ë“±ì˜ ë³€ê²½ì‚¬í•­ ì €ì¥ìš©)
    function saveCompanyList() {
      alert('â„¹ï¸ í˜„ì¬ëŠ” ìë™ ì €ì¥ë©ë‹ˆë‹¤.');
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.addEventListener('load', function() {
      console.log('í’ˆì§ˆê´€ë¦¬ ì‹œìŠ¤í…œ v2.0 ë¡œë“œ ì™„ë£Œ');
      
      // ì—…ì²´ ëª©ë¡ ìë™ ë¡œë“œ
      
      // ëŒ€ì‹œë³´ë“œ í†µê³„ ì—…ë°ì´íŠ¸
      updateDashboardStats();
      loadCompanyList();


    // ========================================
    // ëŒ€ì‹œë³´ë“œ í†µê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    // ========================================
    
    function updateDashboardStats() {
      console.log('ëŒ€ì‹œë³´ë“œ í†µê³„ ì—…ë°ì´íŠ¸ ì‹œì‘...');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result || !result.success) {
            console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', result);
            return;
          }
          
          const stats = result.data;
          console.log('ë°›ì€ í†µê³„ ë°ì´í„°:', stats);
          
          // TP-101 ê³µê¸‰ì‚¬í‰ê°€
          updateStatCard('tp101-total', stats.tp101.totalCompanies);
          updateStatCard('tp101-evaluated', stats.tp101.evaluatedCompanies);
          
          // TP-201 ë³€ê²½ì ê´€ë¦¬
          updateStatCard('tp201-changes', stats.tp201.totalChanges);
          updateStatCard('tp201-pending', stats.tp201.pendingChanges);
          
          // TP-301 ì„±ì ì„œë°œí–‰
          updateStatCard('tp301-docs', stats.tp301.totalDocuments);
          updateStatCard('tp301-issued', stats.tp301.issuedCount);
          
          // TP-401 ë„ë©´ê´€ë¦¬
          updateStatCard('tp401-drawings', stats.tp401.totalDrawings);
          updateStatCard('tp401-revisions', stats.tp401.revisionCount);
          
          // TP-501 í˜„ì¥ê´€ë¦¬
          updateStatCard('tp501-sites', stats.tp501.totalSites);
          updateStatCard('tp501-active', stats.tp501.activeSites);
          
          // TP-601 ê³ ê°ë¶ˆë§Œ
          updateStatCard('tp601-complaints', stats.tp601.totalComplaints);
          updateStatCard('tp601-resolved', stats.tp601.resolvedRate + '%');
          
          // TP-701 ê³µì •ê²€ì‚¬
          updateStatCard('tp701-inspections', stats.tp701.totalInspections);
          updateStatCard('tp701-pass', stats.tp701.passRate + '%');
          
          // TP-801 ì•„ìƒë™ì‘ê²€ì¦
          updateStatCard('tp801-tests', stats.tp801.totalTests);
          updateStatCard('tp801-passed', stats.tp801.passedTests);
          
          // TP-901 ì‘ì—…í‘œì¤€ì„œ
          updateStatCard('tp901-docs', stats.tp901.totalDocs);
          updateStatCard('tp901-revisions', stats.tp901.revisionCount);
          
          // TP-1001 ì´ˆí’ˆSOP
          updateStatCard('tp1001-sops', stats.tp1001.totalSOPs);
          updateStatCard('tp1001-approved', stats.tp1001.approvedSOPs);
          
          // TP-1101 ê²€ì‚¬ê¸°ì¤€
          updateStatCard('tp1101-standards', stats.tp1101.totalStandards);
          updateStatCard('tp1101-active', stats.tp1101.activeStandards);
          
          console.log('ëŒ€ì‹œë³´ë“œ í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ!');
        })
        .withFailureHandler(function(error) {
          console.error('í†µê³„ ë¡œë“œ ì—ëŸ¬:', error);
        })
        .getDashboardStats();
    }
    
    function updateStatCard(id, value) {
      const element = document.getElementById(id);
      if (element) {
        // ìˆ«ìì— ì²œ ë‹¨ìœ„ ì½¤ë§ˆ ì¶”ê°€
        const formattedValue = typeof value === 'number' ? 
          value.toLocaleString('ko-KR') : value;
        element.textContent = formattedValue;
      }
    }
    // ========================================
    // ë©”ë‰´ ê´€ë¦¬ í•¨ìˆ˜ë“¤
    // ========================================
    
    let currentMenuData = [];
    let editingMenuId = null;
    
    function loadMenuList() {
      // í˜„ì¬ HTMLì—ì„œ ë©”ë‰´ êµ¬ì¡°ë¥¼ ì½ì–´ì˜¤ê¸°
      const navItems = document.querySelectorAll('.nav-item:not(.nav-subitem)');
      currentMenuData = [];
      
      navItems.forEach((item, index) => {
        const icon = item.querySelector('.icon') ? item.querySelector('.icon').textContent : 'ğŸ“„';
        const text = item.textContent.trim().replace(icon, '').trim();
        const onclick = item.getAttribute('onclick');
        const pageId = onclick ? onclick.match(/showPage\('([^']+)'\)/)?.[1] : '';
        const hasSubmenu = item.querySelector('.expand-icon') !== null;
        
        currentMenuData.push({
          id: pageId || `menu-${index}`,
          icon: icon,
          name: text,
          pageId: pageId,
          order: index + 1,
          hasSubmenu: hasSubmenu
        });
      });
      
      renderMenuCards();
    }
    
    function renderMenuCards() {
      const container = document.getElementById('menuListContainer');
      if (!container) return;
      
      container.innerHTML = currentMenuData.map(menu => `
        <div class="menu-card" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); padding: 20px; border-radius: 12px; border: 1px solid var(--border); display: flex; align-items: center; gap: 16px; transition: all 0.3s ease;">
          <div style="font-size: 32px; width: 60px; height: 60px; background: var(--bg-glass); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm);">${menu.icon}</div>
          <div style="flex: 1;">
            <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--text-primary);">${menu.name}</h4>
            <div style="font-size: 13px; color: var(--text-tertiary);">
              í˜ì´ì§€ ID: ${menu.pageId || '-'} | ìˆœì„œ: ${menu.order}
              ${menu.hasSubmenu ? ' | <span style="color: var(--primary);">í•˜ìœ„ ë©”ë‰´ ìˆìŒ</span>' : ''}
            </div>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;" onclick="editMenu('${menu.id}')">âœï¸ ìˆ˜ì •</button>
            <button class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;" onclick="moveMenuUp('${menu.id}')" ${menu.order === 1 ? 'disabled' : ''}>â¬†ï¸</button>
            <button class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;" onclick="moveMenuDown('${menu.id}')" ${menu.order === currentMenuData.length ? 'disabled' : ''}>â¬‡ï¸</button>
            <button class="btn btn-danger" style="padding: 8px 12px; font-size: 12px;" onclick="deleteMenu('${menu.id}')">ğŸ—‘ï¸</button>
          </div>
        </div>
      `).join('');
    }
    
    function addNewMenu() {
      editingMenuId = null;
      document.getElementById('editMenuIcon').value = 'ğŸ“„';
      document.getElementById('editMenuName').value = '';
      document.getElementById('editMenuPageId').value = '';
      document.getElementById('editMenuOrder').value = currentMenuData.length + 1;
      document.getElementById('editMenuHasSubmenu').checked = false;
      
      const modal = document.getElementById('menuEditModal');
      modal.style.display = 'flex';
    }
    
    function editMenu(menuId) {
      const menu = currentMenuData.find(m => m.id === menuId);
      if (!menu) return;
      
      editingMenuId = menuId;
      document.getElementById('editMenuIcon').value = menu.icon;
      document.getElementById('editMenuName').value = menu.name;
      document.getElementById('editMenuPageId').value = menu.pageId;
      document.getElementById('editMenuOrder').value = menu.order;
      document.getElementById('editMenuHasSubmenu').checked = menu.hasSubmenu;
      
      const modal = document.getElementById('menuEditModal');
      modal.style.display = 'flex';
    }
    
    function closeMenuEditModal() {
      document.getElementById('menuEditModal').style.display = 'none';
      editingMenuId = null;
    }
    
    function saveMenuEdit() {
      const icon = document.getElementById('editMenuIcon').value.trim();
      const name = document.getElementById('editMenuName').value.trim();
      const pageId = document.getElementById('editMenuPageId').value.trim();
      const order = parseInt(document.getElementById('editMenuOrder').value);
      const hasSubmenu = document.getElementById('editMenuHasSubmenu').checked;
      
      if (!name || !pageId) {
        alert('âŒ ë©”ë‰´ëª…ê³¼ í˜ì´ì§€ IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
      }
      
      if (editingMenuId) {
        // ìˆ˜ì •
        const index = currentMenuData.findIndex(m => m.id === editingMenuId);
        if (index >= 0) {
          currentMenuData[index] = {
            ...currentMenuData[index],
            icon: icon || 'ğŸ“„',
            name: name,
            pageId: pageId,
            order: order,
            hasSubmenu: hasSubmenu
          };
        }
      } else {
        // ì¶”ê°€
        currentMenuData.push({
          id: pageId,
          icon: icon || 'ğŸ“„',
          name: name,
          pageId: pageId,
          order: order,
          hasSubmenu: hasSubmenu
        });
      }
      
      // ìˆœì„œëŒ€ë¡œ ì •ë ¬
      currentMenuData.sort((a, b) => a.order - b.order);
      currentMenuData.forEach((menu, index) => {
        menu.order = index + 1;
      });
      
      renderMenuCards();
      closeMenuEditModal();
      
      alert('âœ… ë©”ë‰´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. "ë³€ê²½ì‚¬í•­ ì €ì¥" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì‹¤ì œ ì ìš©í•˜ì„¸ìš”.');
    }
    
    function moveMenuUp(menuId) {
      const index = currentMenuData.findIndex(m => m.id === menuId);
      if (index <= 0) return;
      
      [currentMenuData[index - 1], currentMenuData[index]] = [currentMenuData[index], currentMenuData[index - 1]];
      
      currentMenuData.forEach((menu, idx) => {
        menu.order = idx + 1;
      });
      
      renderMenuCards();
    }
    
    function moveMenuDown(menuId) {
      const index = currentMenuData.findIndex(m => m.id === menuId);
      if (index < 0 || index >= currentMenuData.length - 1) return;
      
      [currentMenuData[index], currentMenuData[index + 1]] = [currentMenuData[index + 1], currentMenuData[index]];
      
      currentMenuData.forEach((menu, idx) => {
        menu.order = idx + 1;
      });
      
      renderMenuCards();
    }
    
    function deleteMenu(menuId) {
      if (!confirm('ì •ë§ ì´ ë©”ë‰´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      currentMenuData = currentMenuData.filter(m => m.id !== menuId);
      
      currentMenuData.forEach((menu, index) => {
        menu.order = index + 1;
      });
      
      renderMenuCards();
    }
    
    function saveMenuChanges() {
      alert('ğŸ’¡ ë©”ë‰´ êµ¬ì¡°ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\nì‹¤ì œ HTML íŒŒì¼ì„ ì—…ë°ì´íŠ¸í•˜ë ¤ë©´:\\n1. í˜„ì¬ ë©”ë‰´ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³ \\n2. ê°œë°œìì—ê²Œ ì „ë‹¬í•˜ì—¬ HTML íŒŒì¼ì„ ì—…ë°ì´íŠ¸í•´ì•¼ í•©ë‹ˆë‹¤.\\n\\ní˜„ì¬ ë°ì´í„°:\\n' + JSON.stringify(currentMenuData, null, 2));
    }
    });
  </script>
